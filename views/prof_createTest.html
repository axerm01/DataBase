<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Test - ESQL -</title>
    <link rel="shortcut icon" href="image/Seal_Bologna.svg.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleBACK.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="check_session.js"></script>
<style>
    .question {
        margin-top: 20px;
        border: 1px solid #ccc; 
        border-radius: 5px; 
        padding: 15px; 
        background-color: #f9f9f9; 
        margin-right: 10px;
    }

    .question-input {
        padding: 10px; 
        margin-top: 15px; 
        border: 1px solid #ccc; 
        border-radius: 5px; 
        box-sizing: border-box; 
        font-size: 16px;
        background-color: #f9f9f9; 
        color: #333;
    }
    .question input[type="text"] {
        width: 500px;
    }

    .answer {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .answer input[type="text"] {
        flex: 1;
        margin-right: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .answer input[type="checkbox"] {
        margin-right: 5px;
        transform: scale(1.5); 
        margin-left: 10px;
    }

    .add-answer-button {
        background-color: #007bff;
        cursor: pointer;
        font-size: 12px;
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .add-check-button {
        background-color: #15c11e;
        cursor: pointer; 
        font-size: 12px;
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .delete-question-button {
        background-color: #de1515;
        cursor: pointer;
        font-size: 12px;
        width: 80px;
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .delete-button {
        background-color: #de1515;
        cursor: pointer;
        font-size: 10px;
        width: 70px;
        padding: 5px;
        color: #fff;
        border: white;
        padding: 8px 20px;
        border-radius: 5px;
        transition: background-color 0.3s;
        margin-left: 10px;
    }

    .delete-answer-button {
        background-color: #de1515;
        color: #fff;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }

    .code-textarea {
        width: 100%;
        height: 100px; 
        padding: 10px; 
        margin-top: 15px; 
        border: 1px solid #ccc; 
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 16px; 
        background-color: #f9f9f9; 
        color: #333;
    }

    input[type="checkbox"] {
        border-radius: 25%;
        transform: scale(1.5); 
    }

    .table-container {
        display: inline-block;
        flex-wrap: nowrap;
        margin: 10px 5px 0px 5px;
        font-size: small;
        justify-content: center;
        font-weight: bold;
    }
    table {
        display: inline-table;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #ddd; 
        padding: 5px; 
    }

    td {
        font-weight: lighter;
    }

    th {
        background-color: #f2f2f2; 
    }

    .difficulty-select {
        margin-top: 6px;
        width: 100px;
        padding: 8px;
        border: 2px solid #ccc;
        border-radius: 5px;
        margin-right: 5px;
        margin-left: 5px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: fit-content;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .image-container {
        background-color: #f3f3f3; 
        border: 2px dashed #d3d3d3; 
        padding: 10px;
        margin: 0px 0px 10px 20px;
        width: 70%;
        text-align: center;
        justify-content: center;
        align-items: center;
    }

    .file-input {
        opacity: 0;
        position: absolute;
        width: 0;
        height: 0;
        z-index: -1;
    }

    .file-input-label {
        background-color: #3a8e3d; 
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
        font-size: 14px;
        font-family: Arial, sans-serif;
        transition: background-color 0.3s;
    }

    .file-input-label:hover {
        background-color: #367c39;
    }

    .file-name {
        display: block;
        color: #555;
        font-size: 14px;
        margin-top: 10px;
    }

    .image-preview {
        max-width: 250px;
        height: auto;
        margin-top: 10px;
        margin-left: auto;
        margin-right: auto;
        border-radius: 5px;
        display: none;
        border: 2px solid #ccc; 
        border-radius: 5px;  
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
    }

    .main-content {
        display: flex;
        align-items: center; 
    }
</style>
</head>

<body>
    <header>
        <h1>Studia con ESQL</h1>
        <div class="indietro">
            <!-- Usa "javascript:history.back()" come href per tornare indietro -->
            <span class="testo-indietro"><a href="javascript:history.back()">
                <img src="image/arrow.png" alt="Torna indietro" style="width: 25px; height: 25px;">
            </a>Indietro</span>
        </div> 
        <div class="logout-form">
            <form action="../controllers/utils/logout.php" method="post">
                <button type="submit" name="logout">Esci</button>
            </form>
        </div>  
    </header>
    <div class="main-container">
        <div class="main-content">
            <span style="margin-right: 10px; font-size: 28px; font-weight: bold;">Crea Test</span>
            <div class="image-container">
                <label for="testImage" class="file-input-label">Carica immagine</label>
                <input type="file" id="testImage" name="testImage" accept="image/*" class="file-input">
                <span id="fileName" class="file-name">Nessun file selezionato</span>
                <!-- Elemento per l'anteprima dell'immagine -->
                <img id="imagePreview" src="#" class="image-preview">
            </div>
        </div>
        <label for="title" style="font-size: 22px; font-weight: bolder;">Titolo Test:</label>
        <input type="text" id="title" name="title"><br>
        
        <button class="black-button" onclick="addMenuTable()">Seleziona Tabelle Necessarie</button>
        <div id="menuContainer">
            <!-- Div per il menu a tendina, inizialmente vuoto -->
        </div>
        
        <button class="black-button" onclick="addConstraints()">Aggiungi Vincoli integrità</button>
        <div id="constraintsContainer">
            <!-- Qui verranno aggiunti i menu a tendina -->
        </div>
        
        <button class="black-button" onclick="addCodeQuestion()">Aggiungi Quesito Codice</button>
        <button class="black-button" onclick="addMCQuestion()">Aggiungi Quesito Risposta Multipla</button>
    </div>


    <div id="questionsContainer">
        <!-- Qui verranno aggiunti i container per le question -->
    </div>

    <button id="submitTestButton">Crea Test</button> <!-- Bottone salvataggio -->

    <!-- Modale per la visualizzazione della tabella -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <div id="tableContainer"></div> <!-- Contenitore per la tabella -->
        </div>
    </div>
    
    <script>
        document.getElementById('testImage').addEventListener('change', function(event) {
            if (event.target.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(event.target.files[0]);
    
                // Mostra il nome del file selezionato
                const fileNameDisplay = document.getElementById('fileName');
                fileNameDisplay.textContent = event.target.files[0].name;
            }
        });
    </script>
    <script>
        // Variabile per memorizzare il nome della tabella selezionata
        var selectedTable = "";
        var tables = []; // Array per tenere traccia delle tabelle scelte
    
        function addMenuTable() {
            // Effettua una richiesta AJAX per ottenere i nomi delle tabelle dal file PHP
            $.ajax({
                type: "GET",
                url: "../controllers/table/TableController.php?action=get_tables",
                data: { },
                success: function(data) {
                    console.log("Successo:", data);
                    // Agisci qui con i dati ricevuti
                    // Crea il menu a tendina con lo stesso stile di addConstraints
                    var select = $("<select class='dropdown-table' name='tabelle'></select>"); // Usa 'dropdown-table' per il primo menu
                    // Aggiungi un'opzione di placeholder disabilitata e selezionata di default
                    select.append("<option value='' disabled selected>Sel.Tabella</option>");
                    // Itera attraverso l'array ricevuto e aggiungi le opzioni al menu a tendina
                    $.each(data, function(index, value) {
                        select.append("<option value='" + value.IDTabella + "'>" + value.Nome + "</option>");
                    });
                    $.each(tables, function(index, v) {
                        // Rimuove l'opzione dal select con l'ID corrispondente
                        select.find("option[value='" + v.id + "']").remove();
                    });

                    // Inserisci il menu a tendina nel contenitore
                    $("#menuContainer").append(select);

                    // Aggiungi un gestore per l'evento di cambio al menu a tendina
                    select.change(function() {
                        // Nasconde il menu a tendina dopo la selezione
                        $(this).hide();
                        // Esegue le azioni necessarie in base alla selezione
                        var selectedTable = {
                            id: $(this).val(),
                            name: $(this).find("option:selected").text()
                        };
                         // Rimuovi l'opzione selezionata dal menu a tendina
                        //$(".dropdown-table option[value='" + selectedTable.id + "']").remove();
                        tables.push(selectedTable); // Memorizza le tabelle selezionate
                        updateMenuTable1();
                        console.log("Tabella selezionata: ", selectedTable);
                        requestData(selectedTable.id,selectedTable.name); // Invia i dati della tabella selezionata
                        // Crea e aggiungi il bottone di eliminazione per questa specifica tabella selezionata
                        //deleteTable(selectedTable.id);
                    });
                },
                dataType: "json"
            }).fail(function(jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                var data = JSON.parse(jqxhr.responseText);
                console.log("Parsed response data: ", data);
                console.log("Request Failed: " + err);
            });
        }
        
        function deleteTable(tableId) {
            const deleteButton = $("<button class='delete-button'>Elimina Tabella</button>");
            deleteButton.click(function() {
                // Rimuovi la tabella dall'array tables
                tables = tables.filter(table => table.id !== tableId);
                // Aggiorna il menu a tendina delle tabelle
                updateMenuTable1();

                // Rimuovi la rappresentazione visiva della tabella dal DOM
                $("#table-" + tableId).remove(); // Usa l'ID univoco per rimuovere la tabella
                $(this).remove(); // Assumendo che il bottone sia all'interno di un contenitore parent
                
            });

            // Qui dovresti aggiungere il bottone al DOM, ad esempio appenderlo
            // al contenitore della tabella selezionata o in un altro posto appropriato
            // Ad esempio, se mostri le tabelle selezionate in #selectedTablesContainer:
            $("#menuContainer").append(deleteButton);
        }

        // Funzione per inviare la variabile selectedTable al file PHP
        function requestData(selectedID,selectedName) {
            // AJAX request to send data to the PHP file and receive table data
            $.ajax({
                type: "GET", // Metodo HTTP utilizzato
                url: "../controllers/table/TableController.php?action=get_full_table", // URL a cui viene fatta la richiesta
                data: { tableId: selectedID }, // Dati inviati al server
                success: function(response) {
                    console.log("Data received from the server: ", response);

                // Crea un contenitore per la tabella e il bottone di eliminazione
                var tableContainer = $("<div class='table-container'></div>").attr("id", "container-" + selectedID);
        
                // Crea il bottone di eliminazione
                var deleteButton = $("<button class='delete-button'>Elimina</button>");
                deleteButton.click(function() {
                    // Rimuovi la tabella e il bottone dall'array tables e dal DOM
                    tables = tables.filter(table => table.id !== selectedID);
                    tableContainer.remove(); // Rimuovi il contenitore che include la tabella e il bottone
                    updateMenuTable1();// Aggiorna il menu a tendina delle tabelle
                });
                
                // Aggiungi il bottone di eliminazione al contenitore della tabella
                tableContainer.append(selectedName, deleteButton);
                tableContainer.append($("<br>"));
                // Assuming the response is an array of objects, where each object represents a table row
                // Create a table element
                    const col = response.length > 1 ? Object.keys(response[1]) : [];
                    //ultimo paramentro il nome è null perche preferisco inserirlo vicino al bottone
                    tableContainer.append(createTableMain(response.slice(1),col,null));
                $("#menuContainer").append(tableContainer);
                // Expecting response in JSON format
            },
                dataType: "json" // Specifica il tipo di dati attesi in risposta
            }).fail(function(jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                console.log("Request Failed: " + err);
            });
        }

        function addConstraints() {
            const container = document.getElementById('constraintsContainer');
            const dropdownsDiv = document.createElement('div');
            dropdownsDiv.classList.add('flex-container');

            // Genera un identificativo unico per questo gruppo di dropdown
            const uniqueId = 'group-' + document.querySelectorAll('.flex-container').length;
            dropdownsDiv.id = uniqueId; // Assegna un ID univoco al container dei dropdown

            let optionsForMenuTable1 = tables.map(table => `<option value="${table.id}">${table.name}</option>`).join('');

            const menuTable1 = document.createElement('select');
            menuTable1.id = uniqueId + '-menuTable1';
            menuTable1.classList.add('dropdown-table');
            menuTable1.innerHTML = `<option value="" disabled selected>Sel.Tabella</option>` + optionsForMenuTable1;
            dropdownsDiv.appendChild(menuTable1);

            // Crea gli altri menu a tendina
            const menuAttribute1 = document.createElement('select');
            menuAttribute1.id = uniqueId + '-menuAttribute1';
            menuAttribute1.classList.add('dropdown-attribute');
            dropdownsDiv.appendChild(menuAttribute1); // Aggiunto al DOM qui

            const arrow = document.createElement('span');
            arrow.id = uniqueId + '-arrow';
            arrow.style.display = 'none';
            arrow.classList.add('separator');
            dropdownsDiv.appendChild(arrow);     // Assicurati che la freccia sia aggiunta al container

            const menuTable2 = document.createElement('select');
            menuTable2.id = uniqueId + '-menuTable2';
            menuTable2.classList.add('dropdown-table');
            dropdownsDiv.appendChild(menuTable2); // Aggiunto al DOM qui

            const menuAttribute2 = document.createElement('select');
            menuAttribute2.id = uniqueId + '-menuAttribute2';
            menuAttribute2.classList.add('dropdown-attribute');
            dropdownsDiv.appendChild(menuAttribute2); // Aggiunto al DOM qui

            // Gestore dell'evento onchange per menu1
            menuTable1.onchange = function() {
                const selectedTableId = this.value;
                const otherTablesOptions = tables
                    .filter(table => table.id !== selectedTableId)
                    .map(table => `<option value="${table.id}">${table.name}</option>`)
                    .join('');

                $.ajax({
                    type: "GET", // Imposta il metodo HTTP su GET
                    url: "../controllers/table/TableController.php?action=get_table_columns", // URL a cui fare la richiesta
                    data: { tableId: selectedTableId }, // Dati inviati al server come parte della richiesta
                    success: function(columns) {
                        // Costruisci le opzioni del menu a tendina usando i dati ricevuti
                        menuAttribute1.innerHTML = `<option value="" disabled selected>Seleziona Attributo</option>` + columns.map(col => `<option value="${col.Nome}">${col.Nome}</option>`).join('');
                        menuAttribute1.style.display = 'block'; // Mostra il menu a tendina
                        arrow.style.display = 'inline-block'; // Mostra la freccia (assumendo che sia un elemento del tuo DOM)
                    },
                    dataType: "json" // Aspettati una risposta in formato JSON
                });
                menuTable2.innerHTML = `<option value="" disabled selected>Sel.Tabella</option>` + otherTablesOptions;
                menuTable2.style.display = 'block';
            };

            // Ora, poiché menuTable2 è già parte del DOM, puoi aggiungere il gestore dell'evento onchange direttamente
            menuTable2.onchange = function() {
                const selectedTableId = this.value;

                $.ajax({
                    type: "GET", // Imposta il metodo HTTP su GET
                    url: "../controllers/table/TableController.php?action=get_table_columns", // URL a cui fare la richiesta
                    data: {tableId: selectedTableId},
                    success: function(columns) {
                        menuAttribute2.innerHTML = `<option value="" disabled selected>Seleziona Attributo</option>` + columns.map(col => `<option value="${col.Nome}">${col.Nome}</option>`).join('');
                        menuAttribute2.style.display = 'block';
                    },
                    dataType: "json" // Aspettati una risposta in formato JSON
                });
            };
            // Aggiunta del bottone di eliminazione al DIV contenitore dei dropdown
            deleteConstraint(uniqueId, dropdownsDiv, container);
            // Infine, aggiungi il div dei menu a tendina al container
            container.appendChild(dropdownsDiv);
        }

        function updateMenuTable1() {
            // Trova il container del menu 1 e lo svuota
            const menuTable1 = document.getElementById('group-0-menuTable1');
            if (!menuTable1) return; // Se il menu 1 non esiste, esce dalla funzione
            menuTable1.innerHTML = "<option value='' disabled selected>Sel.Tabella</option>"; // Reset

            // Popola di nuovo il menu con le tabelle aggiornate
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = table.name;
                menuTable1.appendChild(option);
            });
        }

        function deleteConstraint(uniqueId, dropdownsDiv, container) {
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Elimina Vincolo';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                // Rimuovi la riga/menu dal DOM
                container.removeChild(dropdownsDiv);
                // Assumi che ogni vincolo corrisponda a una tabella e voglia rimuovere quella tabella dall'array tables
                // Questo passaggio richiede che tu abbia una corrispondenza tra l'ID del gruppo di vincoli e l'ID della tabella
                // Qui manca la logica per identificare la tabella corrispondente, quindi adattalo alle tue esigenze
                // tables = tables.filter(t => t.id !== someId);
                updateMenuTable1(); // Aggiorna il menu delle tabelle dopo la rimozione
            };

            dropdownsDiv.appendChild(deleteButton); // Aggiunge il bottone di eliminazione al div dei dropdown
        }

    </script>
    <script>
        let questionMCCount = 0;
        let questionCodeCount = 0;
        function addMCQuestion() {
            questionMCCount++;

            const container = document.getElementById('questionsContainer');

            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');
            questionDiv.setAttribute('data-question-type', 'mc');

            const questionLabel = document.createElement('label');
            questionDiv.appendChild(questionLabel);

            const questionInput = document.createElement('input');
            questionInput.type = 'text';
            questionInput.name = 'question' + questionMCCount;
            questionInput.placeholder = 'Scrivi la Domanda';
            questionInput.classList.add('question-input');
            questionDiv.appendChild(questionInput);

            const deleteQuestionButton = document.createElement('button');
            deleteQuestionButton.textContent = 'Elimina Quesito';
            deleteQuestionButton.classList.add('delete-question-button');
            deleteQuestionButton.onclick = function() {
                container.removeChild(questionDiv);
            };
            questionDiv.appendChild(deleteQuestionButton);

            const answersContainer = document.createElement('div');
            answersContainer.classList.add('answers-container');
            questionDiv.appendChild(answersContainer);

            const addAnswerButton = document.createElement('button');
            addAnswerButton.textContent = 'Aggiungi Risposta';
            addAnswerButton.classList.add('add-answer-button');
            addAnswerButton.onclick = function() {
                addAnswer(answersContainer);
            };
            questionDiv.appendChild(addAnswerButton);

            // Crea il menu a tendina per la difficoltà
            const difficultySelect = document.createElement('select');
            difficultySelect.name = 'difficulty' + questionMCCount;
            difficultySelect.classList.add('difficulty-select');
            // Opzione non selezionabile come etichetta
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Difficoltà:";
            defaultOption.disabled = true; // la rende non selezionabile
            defaultOption.selected = true; // la seleziona fino a che non si cambia dall utende
            difficultySelect.appendChild(defaultOption);
            // Opzioni per il menu a tendina
            const difficultyLevels = ["Basso", "Medio", "Alto"];
            difficultyLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.toLowerCase();
                option.textContent = level;
                difficultySelect.appendChild(option);
            });
            // Aggiungi listener per cambiare il colore in base alla selezione
            difficultySelect.addEventListener('change', function() {
                switch(this.value) {
                    case 'basso':
                        this.style.backgroundColor = '#77dd77'; // Verde
                        break;
                    case 'medio':
                        this.style.backgroundColor = '#fbdc52'; // Giallo
                        break;
                    case 'alto':
                        this.style.backgroundColor = '#ff6961'; // Rosso
                        break;
                    default:
                        this.style.backgroundColor = ''; // Resetta allo stile di default se necessario
                }
            });
            questionDiv.appendChild(difficultySelect);

            container.appendChild(questionDiv);
        }

        function addAnswer(container) {
            const answerDiv = document.createElement('div');
            answerDiv.classList.add('answer');

            const answerInput = document.createElement('input');
            answerInput.type = 'text';
            answerInput.name = 'answer' + questionMCCount + '_' + (container.children.length + 1);
            answerInput.placeholder = 'Inserisci Risposta';
            answerInput.classList.add('answer-input');
            answerDiv.appendChild(answerInput);

            const correctCheckbox = document.createElement('input');
            correctCheckbox.type = 'checkbox';
            correctCheckbox.name = 'correct' + questionMCCount + '_' + (container.children.length + 1);
            correctCheckbox.classList.add('correct-checkbox');
            answerDiv.appendChild(correctCheckbox);

            const deleteAnswerButton = document.createElement('button');
            deleteAnswerButton.textContent = 'Elimina';
            deleteAnswerButton.classList.add('delete-answer-button');
            deleteAnswerButton.onclick = function() {
                container.removeChild(answerDiv);
            };
            answerDiv.appendChild(deleteAnswerButton);

            container.appendChild(answerDiv);
        }

         function addCodeQuestion() {
            questionCodeCount++;

            const container = document.getElementById('questionsContainer');

            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');
            questionDiv.setAttribute('data-question-type', 'code'); // Identifica il tipo di domanda

            const questionLabel = document.createElement('label');
            //questionLabel.textContent = 'D.' + questionCodeCount + ' Code: ';
            questionDiv.appendChild(questionLabel);

            const questionInput = document.createElement('input');
            questionInput.type = 'text';
            questionInput.name = 'question' + questionCodeCount;
            questionInput.placeholder = 'Scrivi la Domanda';
            questionInput.classList.add('question-input');
            questionDiv.appendChild(questionInput);

            const deleteQuestionButton = document.createElement('button');
            deleteQuestionButton.textContent = 'Elimina Quesito';
            deleteQuestionButton.classList.add('delete-question-button');
            deleteQuestionButton.onclick = function() {
                container.removeChild(questionDiv);
            };
            questionDiv.appendChild(deleteQuestionButton);
            

           // Adding MySQL code textarea
            const codeTextarea = document.createElement('textarea');
            codeTextarea.name = 'code' + questionCodeCount;
            codeTextarea.placeholder = 'Inserisci codice MySQL';
            codeTextarea.classList.add('code-textarea');
            questionDiv.appendChild(codeTextarea);
            
            const addCodeAnswerButton = document.createElement('button');
            addCodeAnswerButton.textContent = 'Verifica Codice';
            addCodeAnswerButton.classList.add('add-check-button');
            addCodeAnswerButton.onclick = function() {
                codeCheck(this);
            };
            questionDiv.appendChild(addCodeAnswerButton);

            // Crea il menu a tendina per la difficoltà
            const difficultySelect = document.createElement('select');
            difficultySelect.name = 'difficulty' + questionMCCount;
            difficultySelect.classList.add('difficulty-select');
            // Opzione non selezionabile come etichetta
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Difficoltà:";
            defaultOption.disabled = true; // la rende non selezionabile
            defaultOption.selected = true; // la seleziona fino a che non si cambia dall utende
            difficultySelect.appendChild(defaultOption);
            // Opzioni per il menu a tendina
            const difficultyLevels = ["Basso", "Medio", "Alto"];
            difficultyLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.toLowerCase();
                option.textContent = level;
                difficultySelect.appendChild(option);
            });
            // Aggiungi listener per cambiare il colore in base alla selezione
            difficultySelect.addEventListener('change', function() {
                switch(this.value) {
                    case 'basso':
                        this.style.backgroundColor = '#77dd77'; // Verde
                        break;
                    case 'medio':
                        this.style.backgroundColor = '#fbdc52'; // Giallo
                        break;
                    case 'alto':
                        this.style.backgroundColor = '#ff6961'; // Rosso
                        break;
                    default:
                        this.style.backgroundColor = ''; // Resetta allo stile di default se necessario
                }
            });
            questionDiv.appendChild(difficultySelect);
            container.appendChild(questionDiv);
        }

        function codeCheck(buttonElement) {
            // Trova il contenitore della domanda relativo al bottone
            const questionDiv = buttonElement.closest('.question');
            // Trova il textarea all'interno di questo contenitore specifico
            const textarea = questionDiv.querySelector('.code-textarea');
            // Ottenere il codice MySQL inserito dall'utente
            const query = textarea.value;

            // Effettuare una chiamata AJAX per inviare il codice al server
            $.ajax({
                type: 'POST', // Tipo di richiesta HTTP
                url: '../controllers/test/TestController.php',
                data: { query: query, action: 'test_query'}, // Dati inviati al server
                success: function(response) {
                    // Converti la risposta in stringa se è un oggetto JSON
                    response = typeof response === 'object' ? JSON.stringify(response) : response;

                    if (response.startsWith('Forbidden')) {
                        alert(response);
                    } else {
                        if (response.length > 0) {
                            showTableModal(JSON.parse(response));
                        } else {
                            alert('Il codice non è valido!');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    // Gestione degli errori
                    if (xhr.status === 0) {
                        alert('Errore di rete durante la verifica del codice.');
                    } else {
                        alert('Errore durante la verifica del codice:'+ xhr.responseText);
                    }
                },
                dataType: 'json' // Tipo di dati attesi dalla risposta
            });
        }
    </script>
    <script>
        function showTableModal(response) {
            // Creazione della tabella come prima
            const col = response.length > 0 ? Object.keys(response[0]) : [];
            const table = createTableMain(response, col, null);

            // Trova il contenitore della tabella nel modale e aggiungi la tabella
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = ''; // Pulisce vecchie tabelle se presenti
            tableContainer.appendChild(table);

            // Mostra il modale
            const modal = document.getElementById('modal');
            modal.style.display = 'block';

            // Imposta l'evento per chiudere il modale
            const closeButton = document.querySelector('.close-button');
            closeButton.onclick = function() {
                modal.style.display = 'none';
            };

            // Chiude il modale anche quando si clicca fuori dal suo contenuto
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        }

        function createTableMain(resp,columns,tName) {
            console.log(resp);
            const table = document.createElement('table');
            table.className = 'custom-table';
            const caption = document.createElement('caption');
            caption.textContent = tName;
            caption.className = 'caption-table';
            
            // Creazione delle intestazioni della tabella
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            if(caption.textContent){
                thead.prepend(caption);
            }
            columns.forEach(colName => {
                const th = document.createElement('th');
                th.textContent = colName;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Creazione del corpo della tabella
            const tbody = document.createElement('tbody');
            resp.forEach(obj => {
                const tr = document.createElement('tr');
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = obj[column];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // Restituisce l'elemento <table> creato
            return table;
        }
    </script>
    <script>
        

        function pickupData() {
            var sendDataTest = {
                title: $('#title').val(),
                questions: [], // Questo sarà riempito con le domande
                tables: tables, // Assumo che 'tables' sia già un array di oggetti come mostrato
                constraints: [], // Questo dovrà essere riempito con i vincoli definiti
                viewAnswersPermission: false 
            };
            // Raccoglie tutte le domande
            let questionId = 1;
            $('#questionsContainer .question').each(function() {
                const questionType = $(this).data('question-type'); // Legge il tipo di domanda
                const questionText = $(this).find('.question-input').val();
                const difficultyLevel = $(this).find('.difficulty-select').val(); // Raccoglie il livello di difficoltà selezionato

                if (questionType === 'mc') {
                    var answers = [];
                    let answerId = 1;
                    let check = false;
                    $(this).find('.answer').each(function() {
                        var answerText = $(this).find('.answer-input').val();
                        var isCorrect = $(this).find('.correct-checkbox').is(':checked');
                        if(isCorrect){
                            check = true;
                        }
                        if(answerText !== ""){
                            answers.push({ id: answerId, text: answerText, isCorrect: isCorrect });
                            answerId++;
                        }
                    });
                    if(questionText === "" || answers.length === 0 || difficultyLevel === null || !check){
                        alert("Attenzione dati o spunte mancanti");
                    }
                    else {
                        sendDataTest.questions.push({ type: "mc", id: questionId, questionText: questionText, answers: answers, difficulty: difficultyLevel });
                        questionId++;
                    }
                }
                else if (questionType === 'code') {
                    var sqlCode = $(this).find('.code-textarea').val();
                    if(questionText === "" || sqlCode === "" || difficultyLevel === null){
                        alert("Attenzione dati mancanti");
                    }
                    else {
                        sendDataTest.questions.push({ type: "code", id: questionId, questionText: questionText, sqlCode: sqlCode, difficulty: difficultyLevel });
                        questionId++;
                    }
                }

            });
            // Raccogliere dati dei vincoli  
            $('.flex-container').each(function(index) {
                // Utilizzo l'index per costruire l'ID unico, basandomi sul tuo schema di naming
                var uniqueId = 'group-' + index; // Assicurati che questo corrisponda a come hai generato l'ID
                var table1Id = $('#' + uniqueId + '-menuTable1').val();
                var attribute1Id = $('#' + uniqueId + '-menuAttribute1').val();
                var table2Id = $('#' + uniqueId + '-menuTable2').val();
                var attribute2Id = $('#' + uniqueId + '-menuAttribute2').val();

                var constraintData = {
                    tab1: table1Id,
                    att1: attribute1Id,
                    tab2: table2Id,
                    att2: attribute2Id
                };
                sendDataTest.constraints.push(constraintData);
                //console.log(sendDataTest.constraints);
            });

            console.log(sendDataTest);
            return sendDataTest;
        }

        function submitFormTest() {
            var sendDataTest = pickupData();
            var name = sendDataTest.title;
            if (name == null || name === "") {
                alert("Per creare un test devi assegnare un titolo diverso da quello degli altri test");
            }
            if (sendDataTest.questions.length === 0) {
                alert("Per creare un test devi inserire almeno una domanda");
            }
            else {

                $.ajax({
                    type: 'GET', // Cambiato in GET
                    url: '../controllers/test/TestController.php?action=check_name&name=' + name, // URL dello script PHP per la verifica del titolo
                    data: {}, // Parametri inviati nella stringa di query URL
                    success: function (data) {
                        if (data) {
                            alert("Il titolo inserito esiste già. Scegline un altro.");
                        } else {
                            var formData = new FormData();

                            // Aggiunge i dati testuali al FormData
                            formData.append("data", JSON.stringify(sendDataTest));


                            // Aggiunge il file immagine al FormData
                            var imageFile = document.getElementById('testImage').files[0];
                            if (imageFile) {
                                formData.append("testImage", imageFile);
                                console.log(imageFile);
                            }
                            // Aggiunge l'action al FormData
                            formData.append("action", "save_test");


                            // Invio dei dati al file PHP tramite AJAX
                            $.ajax({
                                type: 'POST',
                                url: '../controllers/test/TestController.php', //action è gia stata appesa
                                data: formData,
                                contentType: false, // Importante per il corretto invio di FormData
                                processData: false,
                                success: function (response) {
                                    let object = {};
                                    formData.forEach(function (value, key) {
                                        object[key] = value;
                                    });
                                    console.log(JSON.stringify(sendDataTest));
                                    alert(response); //risposta del server
                                    window.location.reload(); // ricarica pagina
                                },
                                error: function (xhr, status, error) {
                                    // Registro l'errore nel console
                                    console.error("Errore AJAX:", {
                                        httpRequestStatus: status,
                                        errorThrown: error,
                                        xhrObject: xhr
                                    });

                                    // Messaggio di errore dettagliato dalla risposta del server se disponibile
                                    var message = "Si è verificato un errore. ";
                                    if (xhr.responseJSON && xhr.responseJSON.message) {
                                        message += xhr.responseJSON.message;
                                    } else if (xhr.responseText) {
                                        try {
                                            var response = JSON.parse(xhr.responseText);
                                            if (response.message) {
                                                message += response.message;
                                            } else {
                                                message += "Dettagli non disponibili.";
                                            }
                                        } catch (e) {
                                            message += "Dettagli non disponibili.";
                                        }
                                    } else {
                                        message += "Dettagli non disponibili.";
                                    }

                                    // Visualizzare un messaggio di errore all'utente
                                    alert(message);
                                }
                            });
                        }
                    }
                });
            }
        }
        // Chiama la funzione definita sopra quando il bottone viene cliccato
        document.getElementById('submitTestButton').addEventListener('click', function(e) {
            e.preventDefault(); // Previene il comportamento di default del form
            submitFormTest(); // Chiama la funzione di sottomissione
        });
    </script>
</body>
<footer>
    <p>Alma Mater Studiorum</p>
    <h3>Università di Bologna</h3>
</footer>
</html>
