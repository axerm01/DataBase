<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Test - ESQL -</title>
    <link rel="shortcut icon" href="image/Seal_Bologna.svg.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Styles for questions */
        .question {
            margin-top: 20px;
            border: 1px solid #ccc; /* Add border around the question */
            border-radius: 5px; /* Add rounded corners for the question box */
            padding: 15px; /* Add padding inside the question box */
            background-color: #f9f9f9; /* Set background color for the question box */
            margin-right: 10px;
        }
        /* Styles for question input */
        .question-input {
            width: 30%; /* Make the input field occupy the full width of its container */
            padding: 10px; /* Add padding for better visual appeal */
            margin-top: 15px; /* Add some spacing below the input */
            border: 1px solid #ccc; /* Add a border for clarity */
            border-radius: 5px; /* Add rounded corners for a softer look */
            box-sizing: border-box; /* Include padding and border in the width calculation */
            font-size: 16px; /* Increase font size for better readability */
            background-color: #f9f9f9; /* Add a light background color */
            color: #333; /* Set text color */
        }
        .question input[type="text"] {
            width: 70%;
        }

        /* Styles for answers */
        .answer {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Styles for answer input */
        .answer input[type="text"] {
            flex: 1;
            margin-right: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* Styles for answer checkbox */
        .answer input[type="checkbox"] {
            margin-right: 5px;
            transform: scale(1.5); 
            margin-left: 10px;
        }

        /* Styles for add answer button */
        .add-answer-button {
            background-color: #007bff;
            cursor: pointer;
            font-size: 12px;
        }
        /*Styles for check botton*/
        .add-check-button {
            background-color: #15c11e;
            cursor: pointer;
            font-size: 12px;
        }
        /* Styles for "Elimina Quesito" button */
        .delete-question-button {
            background-color: #a51b1bc3;
            cursor: pointer;
            font-size: 12px;
            width: 80px;
        }

        /* Styles for delete answer button */
        .delete-answer-button {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        /* Styles for MySQL code textarea */
        .code-textarea {
            width: 100%; /* Make the textarea occupy the full width of its container */
            height: 100px; /* Set the height as needed */
            padding: 10px; /* Add padding for better visual appeal */
            margin-top: 15px; /* Add some spacing above the textarea */
            border: 1px solid #ccc; /* Add a border for clarity */
            border-radius: 5px; /* Add rounded corners for a softer look */
            box-sizing: border-box; /* Include padding and border in the width calculation */
            font-size: 16px; /* Set font size */
            background-color: #f9f9f9; /* Add a light background color */
            color: #333; /* Set text color */
        }
        /* Styles for inizial checkbox */
        input[type="checkbox"] {
            border-radius: 25%;
            transform: scale(1.5); 
        }
        

    </style>
</head>

<body>
    <header>
        <h1>Studia con ESQL</h1>
    </header>
    <div class="main-container">
        <div style="display: flex; align-items: center;">
            <p style="margin-right: 10px; font-size: 28px; font-weight: bold;">Crea Test</p>
            <button  onclick="addCodeQuestion()">Aggiungi Quesito Codice</button>
            <button  onclick="addMCQuestion()">Aggiungi Quesito Risposta Multipla</button>
        </div>
        <label for="title" style="font-size: 22px; font-weight: bolder;">Titolo Test:</label>
        <input type="text" id="title" name="title"><br>
        <!--il permesso di visualizzazione deve essere fuori da qui. (anche) quando vedo l'elenco dei test gia creati-->
        <!--<p style="font-size: 18px; font-weight: bold; color: #484141b8;"> Permesso visualizzione risposte
            <input type="checkbox" class="styled-checkbox">
            <span class="checkmark"></span>
        </p> -->
        
        <button onclick="addMenu()">Seleziona Tabelle Necessarie</button>
        <div id="menuContainer">
            <!-- Div per il menu a tendina, inizialmente vuoto -->
        </div>
        <div id="tableContainer">
            
        </div>

        <button onclick="addConstraints()">Aggiungi Vincoli integrità</button>
        <div id="constraintsContainer">
            <!-- Qui verranno aggiunti i menu a tendina -->
        </div>
        
        <div id="questionsContainer">
            <!-- Questions will be dynamically added here -->
        </div>
    </div>
    

    <!-- Includi jQuery per semplificare la gestione delle richieste AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        // Variabile per memorizzare il nome della tabella selezionata
        var selectedTable = "";
        var tables = []; // Array per tenere traccia delle scelte
    
        // Definisci la funzione JavaScript che viene chiamata quando il bottone viene premuto
        function addMenu() {
            // Effettua una richiesta AJAX per ottenere i nomi delle tabelle dal file PHP
            $.getJSON("SimulatoreTestController.php", function(data) {
                // Crea il menu a tendina con lo stesso stile di addConstraints
                var select = $("<select class='dropdown-menu1' name='tabelle'></select>"); // Usa 'dropdown-menu1' per il primo menu
                // Aggiungi un'opzione di placeholder disabilitata e selezionata di default
                select.append("<option value='' disabled selected>Selezione tabella</option>");
                // Itera attraverso l'array ricevuto e aggiungi le opzioni al menu a tendina
                $.each(data, function(index, value) {
                    select.append("<option value='" + value.id + "'>" + value.name + "</option>");
                });
                // Inserisci il menu a tendina nel contenitore
                $("#menuContainer").append(select);

                // Aggiungi un gestore per l'evento di cambio al menu a tendina
                select.change(function() {
                    // Nasconde il menu a tendina dopo la selezione
                    $(this).hide();
                    // Esegue le azioni necessarie in base alla selezione
                    var selectedTable = {
                        id: $(this).val(),
                        name: $(this).find("option:selected").text()
                    };
                    tables.push(selectedTable); // Memorizza le tabelle selezionate
                    console.log("Tabella selezionata: ", selectedTable);
                    sendDate(selectedTable); // Invia i dati della tabella selezionata
                });
            });
        }
        // Funzione per inviare la variabile selectedTable al file PHP
        function sendDate(selectedTable) {
            // AJAX request to send data to the PHP file and receive table data
            $.post("SimulatoreInvioDati.php", selectedTable, function(response) {
                console.log("Data received from the server: ", response);
                // Assuming the response is an array of objects, where each object represents a table row
                var table = $("<table></table>"); // Create a table element
                table.append("<tr><th>ID</th><th>Name</th></tr>"); // Add table header

                // Add rows to the table based on received data
                $.each(response, function(index, row) {
                    table.append("<tr><td>" + row.id + "</td><td>" + row.name + "</td></tr>");
                });

                // Clear previous table container and add the new table
                $("#tableContainer").append(table);
            }, "json"); // Expecting response in JSON format
        }
    

        /*function addConstraints() {
            const container = document.getElementById('constraintsContainer');
            const dropdownsDiv = document.createElement('div');
            dropdownsDiv.classList.add('flex-container');

            // Genera un identificativo unico per questo gruppo di dropdown
            const uniqueId = 'group-' + document.querySelectorAll('.flex-container').length;

            // Crea un elemento per la freccia (inizialmente nascosto)
            const arrow = document.createElement('span');
            arrow.id = uniqueId + '-arrow';
            //arrow.innerHTML = '&#x2192;'; // Codice HTML per una freccia verso destra
            arrow.style.display = 'none'; // Nasconde inizialmente la freccia
            arrow.classList.add('separator'); // Aggiungi classi per lo stile se necessario

            // Crea i 4 menu a tendina
            for (let i = 1; i <= 4; i++) {
                const select = document.createElement('select');
                select.id = uniqueId + '-menu' + i; // Assegna un ID unico
                select.classList.add(i === 1 ? 'dropdown-menu1' : 'dropdown-menu');
                if (i !== 4) {
                    select.style.display = i === 1 ? 'block' : 'none'; // Mostra solo il primo menu a tendina
                }
                select.innerHTML = `
                    <option value="">Seleziona opzione</option>
                    <option value="menu${i}.opz1">Menu ${i}.Opzione 1</option>
                    <option value="menu${i}.opz2">Menu ${i}.Opzione 2</option>
                `;
                if (i === 1) {
                    select.onchange = function() { 
                        showDropdown(uniqueId + '-menu1', [uniqueId + '-menu2']); 
                        showDropdown(uniqueId + '-menu2', [uniqueId + '-menu3']); 
                        document.getElementById(uniqueId + '-arrow').style.display = 'inline-block'; // Mostra la freccia
                    };
                }  else if (i === 3) {
                    select.onchange = function() { showDropdown(uniqueId + '-menu3', [uniqueId + '-menu4']); };
                }

                dropdownsDiv.appendChild(select);
                if (i === 2) { // Posiziona la freccia tra il secondo e il terzo menu a tendina
                    dropdownsDiv.appendChild(arrow);
                }
            }

            // Applica la logica per mostrare/nascondere i dropdown basati sulla selezione
            function showDropdown(currentDropdownId, nextDropdownIds) {
                nextDropdownIds.forEach(id => {
                    const dropdown = document.getElementById(id);
                    if (dropdown) dropdown.style.display = 'block';
                });
            }

            container.appendChild(dropdownsDiv);
        }*/
        function addConstraints() {
        const container = document.getElementById('constraintsContainer');
        const dropdownsDiv = document.createElement('div');
        dropdownsDiv.classList.add('flex-container');

        // Genera un identificativo unico per questo gruppo di dropdown
        const uniqueId = 'group-' + document.querySelectorAll('.flex-container').length;

        // Prepara le opzioni per il menu-1 basate sull'array tables
        let optionsForMenu1 = tables.map(table => `<option value="${table.id}">${table.name}</option>`).join('');

        // Crea il primo menu a tendina (menu-1) con le opzioni preparate
        const menu1 = document.createElement('select');
        menu1.id = uniqueId + '-menu1';
        menu1.classList.add('dropdown-menu1');
        menu1.innerHTML = `<option value="" disabled selected>Selezione tabella</option>` + optionsForMenu1;
        dropdownsDiv.appendChild(menu1);

        // Crea un elemento per la freccia (inizialmente nascosto)
        const arrow = document.createElement('span');
        arrow.id = uniqueId + '-arrow';
        //arrow.innerHTML = '&#x2192;'; // Codice HTML per una freccia verso destra
        arrow.style.display = 'none'; // Nasconde inizialmente la freccia
        arrow.classList.add('separator'); // Aggiungi classi per lo stile se necessario

        // Crea gli altri menu a tendina (menu-2, menu-3, e menu-4)
        // Nota: Per questo esempio, sono lasciati vuoti e saranno popolati dinamicamente
        for (let i = 2; i <= 4; i++) {
            const select = document.createElement('select');
            select.id = uniqueId + '-menu' + i;
            select.classList.add('dropdown-menu');
            select.style.display = 'none'; // Nascondi inizialmente questi menu
            dropdownsDiv.appendChild(select);
            if (i === 2) { // Posiziona la freccia tra il secondo e il terzo menu a tendina
                dropdownsDiv.appendChild(arrow);
            }
        }
        
        // Aggiungi la logica per popolare e mostrare menu-2 e menu-3 basata sulla selezione in menu-1
        menu1.onchange = function() {
            // Trova la tabella selezionata e le altre tabelle
            const selectedTableId = this.value;
            const otherTablesOptions = tables
                .filter(table => table.id !== selectedTableId) // Escludi la tabella selezionata in menu-1
                .map(table => `<option value="${table.id}">${table.name}</option>`)
                .join('');

            // Fai una richiesta AJAX per ottenere i nomi delle colonne per la tabella selezionata
            $.post("SimulatoreInvioDatiColonne.php", { action: 'getColumns', tableId: selectedTableId }, function(columns) {
                // Popola menu-2 con i nomi delle colonne ricevuti
                const menu2 = document.getElementById(uniqueId + '-menu2');
                menu2.innerHTML = `<option value="" disabled selected>Seleziona Attributo</option>`+ columns.map(col => `<option value="${col}">${col}</option>`).join('');
                menu2.style.display = 'block';
            }, "json");

            document.getElementById(uniqueId + '-arrow').style.display = 'inline-block'; // Mostra la freccia

            // Popola e mostra menu-3 con tutte le tabelle tranne quella selezionata in menu-1
            const menu3 = document.getElementById(uniqueId + '-menu3');
            menu3.innerHTML = `<option value="" disabled selected>Selezione tabella</option>` + otherTablesOptions;
            menu3.style.display = 'block';
            //Fai una richiesta AJAX per ottenere i nomi delle colonne per la tabella selezionata
            $.post("SimulatoreInvioDatiColonne.php", { action: 'getColumns', tableId: selectedTableId }, function(columns) {
                // Popola menu-4 con i nomi delle colonne ricevuti
                const menu4 = document.getElementById(uniqueId + '-menu4');
                menu4.innerHTML = `<option value="" disabled selected>Seleziona Attributo</option>`+ columns.map(col => `<option value="${col}">${col}</option>`).join('');
                menu4.style.display = 'block';
            }, "json");
            
        };

        // Aggiungi il div dei menu a tendina al container
        container.appendChild(dropdownsDiv);
    }

    </script>

    <script>
        let questionCount = 0;

        function addMCQuestion() {
            questionCount++;

            const container = document.getElementById('questionsContainer');

            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');

            const questionLabel = document.createElement('label');
            //questionLabel.textContent = 'D.' + questionCount + ': ';
            questionDiv.appendChild(questionLabel);

            const questionInput = document.createElement('input');
            questionInput.type = 'text';
            questionInput.name = 'question' + questionCount;
            questionInput.placeholder = 'Scrivi la Domanda';
            questionInput.classList.add('question-input');
            questionDiv.appendChild(questionInput);

            const deleteQuestionButton = document.createElement('button');
            deleteQuestionButton.textContent = 'Elimina Quesito';
            deleteQuestionButton.classList.add('delete-question-button');
            deleteQuestionButton.onclick = function() {
                container.removeChild(questionDiv);
            };
            questionDiv.appendChild(deleteQuestionButton);
            
            const answersContainer = document.createElement('div');
            answersContainer.classList.add('answers-container');
            questionDiv.appendChild(answersContainer);

            const addAnswerButton = document.createElement('button');
            addAnswerButton.textContent = 'Aggiungi Risposta';
            addAnswerButton.classList.add('add-answer-button');
            addAnswerButton.onclick = function() {
                addAnswer(answersContainer);
            };
            questionDiv.appendChild(addAnswerButton);

            container.appendChild(questionDiv);
        }

        function addAnswer(container) {
            const answerDiv = document.createElement('div');
            answerDiv.classList.add('answer');

            const answerInput = document.createElement('input');
            answerInput.type = 'text';
            answerInput.name = 'answer' + questionCount + '_' + (container.children.length + 1);
            answerInput.placeholder = 'Inserisci Risposta';
            answerInput.classList.add('answer-input');
            answerDiv.appendChild(answerInput);

            const correctCheckbox = document.createElement('input');
            correctCheckbox.type = 'checkbox';
            correctCheckbox.name = 'correct' + questionCount + '_' + (container.children.length + 1);
            correctCheckbox.classList.add('correct-checkbox');
            answerDiv.appendChild(correctCheckbox);

            const deleteAnswerButton = document.createElement('button');
            deleteAnswerButton.textContent = 'Elimina';
            deleteAnswerButton.classList.add('delete-answer-button');
            deleteAnswerButton.onclick = function() {
                container.removeChild(answerDiv);
            };
            answerDiv.appendChild(deleteAnswerButton);

            container.appendChild(answerDiv);
        }

        function addCodeQuestion() {
            questionCount++;

            const container = document.getElementById('questionsContainer');

            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');

            const questionLabel = document.createElement('label');
            //questionLabel.textContent = 'D.' + questionCount + ' Code: ';
            questionDiv.appendChild(questionLabel);

            const questionInput = document.createElement('input');
            questionInput.type = 'text';
            questionInput.name = 'question' + questionCount;
            questionInput.placeholder = 'Scrivi la Domanda';
            questionInput.classList.add('question-input');
            questionDiv.appendChild(questionInput);

            const deleteQuestionButton = document.createElement('button');
            deleteQuestionButton.textContent = 'Elimina Quesito';
            deleteQuestionButton.classList.add('delete-question-button');
            deleteQuestionButton.onclick = function() {
                container.removeChild(questionDiv);
            };
            questionDiv.appendChild(deleteQuestionButton);
            
            
            /*const addCodeAnswerButton = document.createElement('button');
            addCodeAnswerButton.textContent = 'Aggiungi altra risposta MySQL';
            addCodeAnswerButton.classList.add('add-answer-button');
            addCodeAnswerButton.onclick = function() {
                addCodeAnswer(questionDiv);
            };
            questionDiv.appendChild(addCodeAnswerButton);*/

           // Adding MySQL code textarea
            const codeTextarea = document.createElement('textarea');
            codeTextarea.name = 'code' + questionCount;
            codeTextarea.placeholder = 'Inserisci codice MySQL';
            codeTextarea.classList.add('code-textarea');
            questionDiv.appendChild(codeTextarea);
            
            const addCodeAnswerButton = document.createElement('button');
            addCodeAnswerButton.textContent = 'Verifica Codice';
            addCodeAnswerButton.classList.add('add-check-button');
            addCodeAnswerButton.onclick = function() {
                codeCheck();
            };
            questionDiv.appendChild(addCodeAnswerButton);

            container.appendChild(questionDiv);
        }
        function codeCheck() {
            // Ottenere il codice MySQL inserito dall'utente
            const code = document.querySelector('.code-textarea').value;

            // Effettuare una chiamata AJAX per inviare il codice al server
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '../controllers/test/TestController.php', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Analizzare la risposta
                    const response = JSON.parse(xhr.responseText);
                    if (response.length > 0) {
                        const table = createTable(response); //
                        document.body.appendChild(table);
                        // Il codice è valido
                        alert('Il codice è valido!');
                    } else {
                        // Il codice non è valido
                        alert('Il codice non è valido!');
                    }
                } else {
                    // Gestione degli errori
                    alert('Errore durante la verifica del codice.');
                }
            };
            xhr.onerror = function() {
                // Gestione degli errori di rete
                alert('Errore di rete durante la verifica del codice.');
            };
            // Invia il codice al server come payload JSON
            xhr.send(JSON.stringify({ code: code }));
        }

        /*function addCodeAnswer(container) {
            const codeAnswerDiv = document.createElement('div');
            codeAnswerDiv.classList.add('code-answer');

            const codeTextarea = document.createElement('textarea');
            codeTextarea.name = 'code' + questionCount + '_' + (container.querySelectorAll('.code-answer').length + 1);
            codeTextarea.placeholder = 'Inserisci codice MySQL';
            codeTextarea.classList.add('code-textarea');
            codeAnswerDiv.appendChild(codeTextarea);

            const deleteAnswerButton = document.createElement('button');
            deleteAnswerButton.textContent = 'Elimina';
            deleteAnswerButton.classList.add('delete-answer-button');
            deleteAnswerButton.onclick = function() {
                container.removeChild(codeAnswerDiv);
            };
            codeAnswerDiv.appendChild(deleteAnswerButton);

            container.appendChild(codeAnswerDiv);
        }*/
        //Non necessario altre risposte possibili perche si verifica sull output

    </script>
</body>
<footer>
    <p>Alma Mater Studiorum</p>
    <h3>Università di Bologna</h3>
</footer>
</html>
